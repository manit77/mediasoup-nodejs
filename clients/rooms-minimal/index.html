<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Mediasoup Raw WS Example</title>
</head>

<body>
    <h2>Mediasoup WebRTC Test</h2>
    userName: <input type="text" id="ctlUserName" />
    RoomId: <input type="text" id="ctlRoomId" /> RoomToken: <input type="text" id="ctlRoomToken" /> <br>
    <button type="button" id="ctlNewRoom">New Room</button> <br>
    <button type="button" id="ctlJoinRoom">Join Room</button> <br>
    <hr>

    <video id="localVideo" autoplay playsinline muted></video>
    <div id="remoteVideos" style="width: 500px; height: 500px; background-color: aquamarine"></div>

    <script>

        const wsUrl = "wss://192.168.40.24:8001";
        const ws = new WebSocket(wsUrl);

        let serviceAuthToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwidHlwZSI6InNlcnZpY2UiLCJyb2xlIjoiYWRtaW4iLCJpYXQiOjE3NTYwODM4NTh9.Kqnh5zEi--_--JNMUkqf7X6WQQYJ57v3ssW5ks5bBbs";

        let authToken = "";
        let username = "";
        let peerId = "";
        let roomId = "";
        let roomName = "test room 1";
        let roomToken = "";
        let roomRtpCapabilities;
        let pcSend;
        let pcReceive;
        let localStream;

        let ctlUserName = document.getElementById("ctlUserName");
        let ctlRoomToken = document.getElementById("ctlRoomToken");
        let ctlRoomId = document.getElementById("ctlRoomId");
        let ctlJoinRoom = document.getElementById("ctlJoinRoom");
        let ctlNewRoom = document.getElementById("ctlNewRoom");

        console.log("ctlNewRoom", ctlNewRoom);

        let peers = [];

        roomId = localStorage.getItem("roomId") ?? "";
        roomToken = localStorage.getItem("roomToken") ?? "";

        ctlRoomId.value = roomId;
        ctlRoomToken.value = roomToken;


        ctlNewRoom.addEventListener("click", (event) => {
            console.log("-- ctlNewRoom click()");
            event.preventDefault();
            event.stopPropagation();

            createRoomToken();
        });

        ctlJoinRoom.addEventListener("click", (event) => {
            console.log("-- ctlJoinRoom click()");
            event.preventDefault();
            event.stopPropagation();

            roomId = ctlRoomId.value;
            roomToken = ctlRoomToken.value;

            joinRoom();
        });


        ws.onopen = async () => {
            console.log("-- Connected to signaling server");
            username = randomString();

            ctlUserName.value = username;

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById("localVideo").srcObject = localStream;

                newAuthToken();

            } catch (err) {
                console.error("Failed to get user media:", err);
            }
        };

        ws.onclose = () => {
            console.error("socket closed");
        }

        ws.onerror = () => {
            console.error("socket onerror");
        }


        ws.onmessage = async (event) => {
            const msg = JSON.parse(event.data);
            console.log("-- onmessage", msg);

            if (msg.data?.error) {
                console.error("Server error:", msg.data.error);
                return;
            }

            switch (msg.type) {
                case "authUserNewTokenResult": {
                    authToken = msg.data.authToken;
                    register();
                    break;
                }
                case "registerPeerResult": {
                    peerId = msg.data.peerId;
                    console.log("-- Registered peer, peerId:", peerId);
                    break;
                }
                case "roomNewTokenResult": {
                    roomId = msg.data.roomId;
                    roomToken = msg.data.roomToken;
                    console.log("-- Room token created, roomId:", roomId);
                    ctlRoomId.value = roomId;
                    ctlRoomToken.value = roomToken;

                    localStorage.setItem("roomId", roomId);
                    localStorage.setItem("roomToken", roomToken);


                    createRoom();
                    break;
                }
                case "roomNewResult": {
                    console.log("-- Room created:", msg);
                    roomRtpCapabilities = msg.data.roomRtpCapabilities;
                    joinRoom();
                    break;
                }
                case "roomJoinResult": {
                    console.log("-- roomJoinResult:", msg);
                    roomRtpCapabilities = msg.data.roomRtpCapabilities;
                    peers = msg.data.peers;

                    createTransports();

                    break;
                }
                case "createProducerTransportResult": {
                    console.log("-- Producer transport created:", msg);
                    const { roomId, transportId, iceParameters, iceServers, iceCandidates, dtlsParameters, iceTransportPolicy } = msg.data;

                    // Verify localStream tracks
                    if (!localStream || !localStream.getTracks().length) {
                        console.error("No tracks in localStream");
                        throw new Error("Invalid localStream");
                    }
                    console.log("Local stream tracks:", localStream.getTracks().map(track => ({
                        kind: track.kind,
                        id: track.id,
                        enabled: track.enabled
                    })));

                    // Create RTCPeerConnection
                    pcSend = new RTCPeerConnection({
                        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
                    });

                    console.log("pcSend created, initial ICE state:", pcSend.iceGatheringState);
                    console.log("Browser:", navigator.userAgent);

                    // Add event listeners for debugging
                    pcSend.onicecandidate = (event) => {
                        console.log("ICE candidate:", event.candidate);
                    };
                    pcSend.onicegatheringstatechange = () => {
                        console.log("ICE gathering state:", pcSend.iceGatheringState);
                    };
                    pcSend.onconnectionstatechange = () => {
                        console.log("Connection state:", pcSend.connectionState);
                    };
                    pcSend.oniceconnectionstatechange = () => {
                        console.log("ICE connection state:", pcSend.iceConnectionState);
                    };

                    // Add tracks
                    localStream.getTracks().forEach(track => {
                        pcSend.addTrack(track, localStream);
                        console.log(`Track added: ${track.kind} (id: ${track.id})`);
                    });

                    // Create and set offer
                    let offer;
                    try {
                        offer = await pcSend.createOffer({ iceRestart: false });
                        console.log("SDP Offer:", offer.sdp);
                        await pcSend.setLocalDescription(offer);
                        console.log("Local description set");
                    } catch (error) {
                        console.error("Error creating/setting offer:", error);
                        throw error;
                    }

                    // Wait for ICE gathering with timeout
                    try {
                        await waitForIceGatheringComplete(pcSend);
                        console.log("ICE gathering completed");
                    } catch (error) {
                        console.error("ICE gathering failed:", error);
                    }

                    send({
                        type: "roomProduceStream",
                        data: {
                            roomId,
                            offer: offer.sdp
                        }
                    });

                    break;
                }
                case "producerTransportConnected": {
                    console.log("-- Producer transport connected", msg.data.answer);

                    await pcSend.setRemoteDescription(new RTCSessionDescription({
                        type: 'answer',
                        sdp: msg.data.answer
                    }));

                    console.log(`answer set`);

                    //we received an answer
                    //let msgIN

                    //we get an answer back
                    //publishTrack("audio");

                    break;
                }
                case "createConsumerTransportResult": {
                    console.log("-- Consumer transport created:", msg);

                     pcReceive = new RTCPeerConnection({
                        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
                    });

                    console.log("pcSend created, initial ICE state:", pcSend.iceGatheringState);
                    console.log("Browser:", navigator.userAgent);

                    // Add event listeners for debugging
                    pcReceive.onicecandidate = (event) => {
                        console.log("ICE candidate:", event.candidate);
                    };
                    pcReceive.onicegatheringstatechange = () => {
                        console.log("ICE gathering state:", pcReceive.iceGatheringState);
                    };
                    pcReceive.onconnectionstatechange = () => {
                        console.log("Connection state:", pcReceive.connectionState);
                    };
                    pcReceive.oniceconnectionstatechange = () => {
                        console.log("ICE connection state:", pcReceive.iceConnectionState);
                    };


                    for (let peer of peers) {
                        for (let producer of peer.producers) {
                            if (producer.kind == "video") {
                                consumeProducer(peer.peerId, producer.producerId);
                                break;
                            }
                        }
                    }

                    break;
                }
                case "consumerTransportConnected": {
                    console.log(`-- consumerTransportConnected`);

                    break;
                }
                case "roomPing": {
                    console.log("-- Received roomPing");
                    send({
                        type: "roomPong",
                        data: { roomId }
                    });
                    break;
                }
                case "roomNewPeer": {
                    console.warn("new peer joined: ", msg.data.peerId);
                    peers.push({
                        peerId: msg.data.peerId,
                        displayName: msg.data.displayName,
                        producers: msg.data.producers,
                        trackInfo: msg.data.trackInfo,
                        tracks: []
                    });

                    //if there are any producers consume them

                    break;
                }
                case "roomNewProducer": {
                    console.warn("new mediatream: ", msg.data.kind);
                    let { kind, producerId } = msg.data;
                    //consume the  producer

                    break;
                }
                case "roomProduceStreamResult": {
                    console.log("-- roomProduceStreamResult stream:", msg);

                    await pcSend.setRemoteDescription(new RTCSessionDescription({
                        type: 'answer',
                        sdp: msg.data.answer
                    }));

                    break;
                }
                case "roomConsumeProducerResult": {
                    console.log("-- roomConsumeProducerResult stream:", msg);

                    const { peerId, producerId, kind, rtpParameters, offer } = msg.data;

                    const peer = peers.find(p => p.peerId === peerId);
                    if (!peer) {
                        console.error(`Peer ${peerId} not found`);
                        return;
                    }

                    pcReceive.ontrack = (event) => {
                        console.log("ontrack", {
                            kind: event.track.kind,
                            id: event.track.id,
                            streamId: event.streams[0]?.id,
                            enabled: event.track.enabled,
                            readyState: event.track.readyState,
                            muted: event.track.muted
                        });

                        // Skip probator track
                        if (event.streams[0]?.id.includes("probator") || event.track.id.includes("probator")) {
                            console.log("Skipping probator track:", event.track.id);
                            return;
                        }

                        // Only handle video tracks
                        if (event.track.kind !== "video") {
                            console.log("Skipping non-video track:", event.track.kind);
                            return;
                        }

                        // Verify remoteVideos container
                        let remoteVideos = document.getElementById("remoteVideos");
                        if (!remoteVideos) {
                            console.error("remoteVideos element not found");
                            return;
                        }

                        // Create video element
                        let video = document.createElement("video");
                        video.id = `video-${event.track.id}`; // Unique ID for debugging
                        video.autoplay = true;
                        video.muted = true; // Required for autoplay
                        video.style.width = "320px"; // Ensure visibility
                        video.style.height = "240px";
                        video.style.backgroundColor = "black";

                        const stream = new MediaStream([event.track]);
                        console.log("MediaStream tracks:", stream.getTracks());
                        video.srcObject = stream;

                        // Attempt to play
                        video.play().catch(error => console.error("Video play failed:", error));

                        // Append to container
                        remoteVideos.appendChild(video);
                        console.log("Video element appended:", video);

                    };

                    pcReceive.setRemoteDescription(new RTCSessionDescription({
                        type: "offer",
                        sdp: offer
                    }));

                    //await waitForIceGatheringComplete(pcSend);

                    let answer = await pcReceive.createAnswer();
                    await pcReceive.setLocalDescription(answer);


                    send({
                        type: "roomConsumeProducerAnswerForWebRTC",
                        data: {
                            roomId: roomId,
                            answer: answer.sdp,
                            remotePeerId: peerId,
                            producerId: producerId
                        }
                    });

                    break;
                }
            }
        };

        async function waitForIceGatheringComplete(pc) {
            console.log(`-- waitForIceGatheringComplete`);

            return new Promise((resolve) => {
                console.log(`--  start ice gathering`);

                if (pc.iceGatheringState === 'complete') {
                    console.log(`--  gathering complete`);
                    resolve();
                } else {
                    console.log(`--  gathering`);

                    const onIceGatheringStateChange = () => {
                        console.log(`pc.iceGatheringState`, pc.iceGatheringState);
                        if (pc.iceGatheringState === 'complete') {
                            pc.removeEventListener('icegatheringstatechange', onIceGatheringStateChange);
                            resolve();
                        }
                    };
                    pc.addEventListener('icegatheringstatechange', onIceGatheringStateChange);
                }
            });
        }

        async function consumeProducer(remotePeerId, producerId) {
            console.log(`-- consumeProducer producerId ${producerId}`);

            if (!remotePeerId) {
                console.error("remotePeerId is required.");
                return;
            }

            if (!producerId) {
                console.error("producerId is required.");
                return;
            }

            const peer = peers.find(p => p.peerId === remotePeerId);
            if (!peer) {
                console.error(`Peer ${remotePeerId} not found`);
                return;
            }

            send({
                type: "roomConsumeProducer",
                data: {
                    roomId,
                    remotePeerId,
                    producerId
                }
            });
        }

        function send(msg) {
            console.log("-- Sending message:", msg);
            ws.send(JSON.stringify(msg));
        }

        function newAuthToken() {
            console.log("-- newAuthToken");

            send({
                type: "authUserNewToken",
                data: {
                    authToken: serviceAuthToken,
                    username: username,
                    role: "user",
                    expiresInMin: 30
                }
            });
        }

        function register() {
            console.log("-- register");
            send({
                type: "registerPeer",
                data: {
                    authToken,
                    username,
                    displayName: username,
                    peerTrackingId: username, // since we don't have one, use the username
                    clientType: "webrtc"
                }
            });
        }

        function createRoomToken() {
            console.log("-- createRoomToken");
            send({
                type: "roomNewToken",
                data: { authToken }
            });
        }

        function createRoom() {
            console.log("-- createRoom");
            send({
                type: "roomNew",
                data: {
                    authToken,
                    peerId,
                    roomId,
                    roomToken,
                    roomName,
                    roomTrackingId: "0"
                }
            });
        }

        function createTransports() {
            console.log("-- createTransports");
            send({
                type: "createProducerTransport",
                data: {
                    roomId
                }
            });

            send({
                type: "createConsumerTransport",
                data: {
                    roomId
                }
            });
        }

        function joinRoom() {
            console.log("-- joinRoom", roomId, roomToken);
            send({
                type: "roomJoin",
                data: {
                    peerId,
                    roomId,
                    roomToken
                }
            });
        }

        function randomString(length = 10) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

    </script>
</body>

</html>